# Call Graph Analyzer - 使用说明

## 项目简介

这是一个功能强大的**多语言函数调用关系分析工具**，可以从项目源代码中提取所有函数之间的调用关系，并使用SQLite数据库持久化保存，支持灵活的查询。

### 支持的编程语言

- ✅ Python
- ✅ C
- ✅ C++
- ✅ Java
- ✅ Rust
- ✅ JavaScript
- ✅ TypeScript
- ✅ Go

## 快速开始

### 1. 安装依赖

```bash
# 进入项目目录
cd /Users/caohaotian/Documents/Projects/call_graph

# 安装依赖（使用 uv）
uv sync
```

### 2. 分析你的项目

```bash
# 分析项目并保存到数据库
uv run call-graph --database 项目名.db analyze /你的项目路径 --clear

# 例如：
uv run call-graph --database myapp.db analyze /Users/你的用户名/projects/myapp --clear
```

### 3. 查询调用关系

#### 查看统计信息

```bash
uv run call-graph --database 项目名.db stats
```

输出示例：
```
总符号数: 156
总调用关系: 234

按语言统计:
  python         :     89 个符号
  javascript     :     45 个符号
  c              :     22 个符号
```

#### 查询谁调用了某个函数

```bash
uv run call-graph --database 项目名.db query 函数名 --callers

# 例如：
uv run call-graph --database myapp.db query process_data --callers
```

输出示例：
```
查询调用 'process_data' 的所有函数:

1. main (/path/to/main.py:33)
2. handle_request (/path/to/api.py:45)
3. batch_process (/path/to/batch.py:12)
```

#### 查询某个函数调用了哪些函数

```bash
uv run call-graph --database 项目名.db query 函数名 --callees

# 例如：
uv run call-graph --database myapp.db query main --callees
```

输出示例：
```
'main' 调用的所有函数:

1. initialize
2. load_config
3. process_data
4. save_results
```

#### 查询完整的调用链

```bash
uv run call-graph --database 项目名.db query 函数名 --chain --depth 3

# 例如：
uv run call-graph --database myapp.db query main --chain --depth 3
```

输出示例：
```
'main' 的调用链:

1. main -> process_data -> validate_input
2. main -> process_data -> transform_data
3. main -> save_results -> write_file
```

#### 搜索函数

```bash
uv run call-graph --database 项目名.db search "搜索关键词"

# 例如：搜索所有包含 "process" 的函数
uv run call-graph --database myapp.db search "process"
```

输出示例：
```
搜索符号 'process':

1. process_data (function) - /path/to/main.py:15
2. process_user (function) - /path/to/user.py:23
3. batch_process (function) - /path/to/batch.py:10
```

### 4. 导出调用关系图

```bash
# 导出为 DOT 格式（可用 Graphviz 生成图片）
uv run call-graph --database 项目名.db export --output 调用图.dot

# 使用 Graphviz 生成图片（需要先安装 graphviz）
dot -Tpng 调用图.dot -o 调用图.png
dot -Tsvg 调用图.dot -o 调用图.svg
```

## Python API 使用

如果你想在 Python 代码中使用这个工具：

```python
from call_graph.analyzer import CallGraphAnalyzer
from call_graph.database import CallGraphDB

# 1. 分析项目
analyzer = CallGraphAnalyzer("我的项目.db")
stats = analyzer.analyze_project("/你的项目路径")
print(f"找到 {stats['total_symbols']} 个函数")
print(f"找到 {stats['total_relations']} 个调用关系")
analyzer.close()

# 2. 查询调用关系
db = CallGraphDB("我的项目.db")

# 查询调用者
callers = db.get_callers("process_data")
for caller in callers:
    print(f"{caller['caller_name']} 调用了 process_data")

# 查询被调用者
callees = db.get_callees("main")
for callee in callees:
    print(f"main 调用了 {callee['callee_name']}")

# 查询调用链
chains = db.get_call_chain("main", depth=3)
for chain in chains:
    print(" -> ".join(chain))

# 搜索函数
results = db.search_symbols("process")
for symbol in results:
    print(f"{symbol['name']} ({symbol['language']})")

db.close()
```

## 测试示例

项目自带了一个示例项目，可以用来测试工具：

```bash
# 分析示例项目
uv run call-graph --database test.db analyze examples/sample_project --clear

# 查看统计
uv run call-graph --database test.db stats

# 查询 main 函数
uv run call-graph --database test.db query main --callees

# 搜索函数
uv run call-graph --database test.db search "calculate"
```

## 常见使用场景

### 场景 1: 理解大型项目的函数调用关系

```bash
# 分析整个项目
uv run call-graph --database bigproject.db analyze /path/to/big/project --clear

# 查看整体统计
uv run call-graph --database bigproject.db stats

# 搜索感兴趣的函数
uv run call-graph --database bigproject.db search "authenticate"

# 查看这个函数的调用关系
uv run call-graph --database bigproject.db query authenticate --callers
uv run call-graph --database bigproject.db query authenticate --callees
```

### 场景 2: 代码重构影响分析

```bash
# 假设你要重构 process_user 函数
# 先查看哪些函数调用了它
uv run call-graph --database myapp.db query process_user --callers

# 这样你就知道重构会影响哪些地方
```

### 场景 3: 查找未使用的函数

```python
from call_graph.database import CallGraphDB

db = CallGraphDB("myapp.db")

# 获取所有函数
all_functions = db.get_symbols_by_kind("function")

# 检查哪些函数没有被调用
for func in all_functions:
    callers = db.get_callers(func['name'])
    if not callers and func['name'] != 'main':
        print(f"未使用的函数: {func['name']} in {func['file']}")

db.close()
```

### 场景 4: 理解函数的完整上下文（新功能）⭐

```bash
# 查询某个函数的完整调用路径
uv run call-graph --database myapp.db query process_user --fullpath --verbose
```

**输出**：
```
从入口函数到目标函数的路径:
1. main -> handle_request -> process_user

从目标函数到叶子函数的路径:
1. process_user -> validate -> check_format
2. process_user -> save_to_db -> execute_query

完整调用路径:
1. main -> handle_request -> [process_user] -> validate -> check_format
2. main -> handle_request -> [process_user] -> save_to_db -> execute_query
```

**Python API**：
```python
from call_graph.analyzer import CallGraphAnalyzer

analyzer = CallGraphAnalyzer("myapp.db")
result = analyzer.query_full_call_paths("process_user", max_depth=10)

print(f"找到 {result['full_count']} 条完整路径")
for path in result['full_paths']:
    print(" -> ".join(path))

analyzer.close()
```

### 场景 4: 生成调用关系文档

```bash
# 导出调用图
uv run call-graph --database myapp.db export --output docs/call_graph.dot

# 生成 PNG 图片
dot -Tpng docs/call_graph.dot -o docs/call_graph.png

# 生成 SVG（可在浏览器中查看）
dot -Tsvg docs/call_graph.dot -o docs/call_graph.svg
```

## 高级选项

### 排除某些目录

```bash
# 排除 node_modules, build 等目录
uv run call-graph --database myapp.db analyze /path/to/project \
  --exclude "node_modules,build,dist,venv,.git"
```

默认已经排除的目录：
- node_modules
- .git
- __pycache__
- venv, env
- build, dist, target
- .idea, .vscode
- bin, obj

### 指定调用链深度

```bash
# 查询更深的调用链（默认 5 层）
uv run call-graph --database myapp.db query main --chain --depth 10
```

### 显示详细信息

```bash
# 搜索时显示函数签名等详细信息
uv run call-graph --database myapp.db search "process" --verbose
```

## 数据库查询

你可以直接使用 SQL 查询数据库：

```bash
# 使用 sqlite3 命令行工具
sqlite3 myapp.db

# 查询最常被调用的函数
SELECT callee_name, COUNT(*) as call_count 
FROM call_relations 
GROUP BY callee_name 
ORDER BY call_count DESC 
LIMIT 10;

# 查询某个文件中的所有函数
SELECT name, start_line, end_line 
FROM symbols 
WHERE file = '/path/to/file.py' 
ORDER BY start_line;
```

## 注意事项

### 工具的局限性

1. **不支持动态调用**：无法分析反射、动态 import、eval 等动态调用
2. **不支持间接调用**：对函数指针、回调函数的支持有限
3. **不支持跨语言调用**：例如 Python 调用 C 扩展
4. **不进行类型推断**：可能无法准确识别重载函数的调用

### 性能建议

- 大型项目首次分析可能需要几分钟时间
- 数据库文件大小通常为源代码的 10-20%
- 使用 `--exclude` 排除不需要分析的目录可以加快速度

## 文档资源

- **README.md**: 完整的英文文档
- **QUICKSTART.md**: 快速开始指南（英文）
- **PROJECT_SUMMARY.md**: 项目技术总结
- **使用说明.md**: 本文件，中文使用指南
- **examples/example_usage.py**: Python API 使用示例代码

## 故障排除

### 问题：ImportError: attempted relative import with no known parent package

**原因**：直接运行 `python call_graph/main.py` 导致导入错误

**解决方案 1（推荐）**：使用 `uv run` 命令

```bash
uv run call-graph --help
```

**解决方案 2**：使用提供的运行脚本

```bash
./run.sh --help
./run.sh --database myproject.db stats
```

**解决方案 3**：激活虚拟环境后运行

```bash
source .venv/bin/activate  # Linux/Mac
call-graph --help
```

**详细说明**：查看 `运行说明.md` 文件了解更多运行方式

### 问题：找不到 call-graph 命令

**解决方案**：使用 `uv run` 前缀运行命令

```bash
uv run call-graph --help
```

### 问题：某些文件解析失败

**检查**：
1. 文件语法是否正确
2. 文件扩展名是否在支持列表中
3. 查看警告信息了解具体原因

### 问题：数据库文件太大

**解决方案**：
```bash
# 清空旧数据重新分析
uv run call-graph --database myapp.db analyze /path/to/project --clear
```

## 联系和反馈

如有问题或建议，欢迎：
- 提交 GitHub Issue
- 改进代码并提交 Pull Request
- 添加新语言支持

## 开源协议

MIT License - 可以自由使用、修改和分发。

---

**祝使用愉快！**

如果这个工具对你有帮助，欢迎分享给其他开发者。

